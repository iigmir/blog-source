# SQL

## åºè¨€

é›–ç„¶æˆ‘æ˜¯å‰ç«¯ï¼Œä½†æˆ‘ä¹Ÿæ˜¯æƒ³è©¦è©¦çœ‹å¾Œç«¯çš„ã€‚æŸæ¬¡é¢è©¦ï¼Œå…¬å¸è¦æ‰¾å¾Œç«¯é–‹ç™¼ï¼Œä½†å¯«åˆ° SQL æ™‚ï¼Œæˆ‘æ‰ç™¼ç¾è‡ªå·±å°å¾Œç«¯æœ€é‡è¦çš„**è³‡æ–™åº«**ä¸€ç„¡æ‰€çŸ¥ã€‚

å¾ˆæ˜é¡¯ï¼Œé€™æ¬¡é¢è©¦è¢«æ‰“æ§äº†ã€‚<small>æœ‰æ²’æœ‰äººæ‡‚éå°ç¨±åŠ å¯†æ€éº¼åšçš„ï¼ˆå°è²ï¼‰</small>

è¦å­¸ SQL çš„è©±ï¼Œé™¤äº†è‡ªå·±æ¶è³‡æ–™åº«å¤–ï¼Œ[SQLZoo](https://sqlzoo.net) é€™ç¶²ç«™ä¹Ÿæ˜¯å€‹å¥½è³‡æºã€‚

2020/03/22 å¢ç­†ï¼šæˆ‘æœ€è¿‘ç™¼ç¾ä»¥æ¢æ¡ˆç‚ºä¸»é¡Œçš„[sql-mysteries](http://mystery.knightlab.com)ä¹Ÿé —å¥½ç©ï¼šéŠæˆ²ç”¨ç”Ÿå‹•çš„æ•…äº‹èˆ‡æŸ¥æ¢æ©Ÿåˆ¶ï¼Œä¾†æ•™äººæ€éº¼ç”¨ `JOIN` æŒ‡ä»¤ï¼Œé—œè¯å…¶ä»–çš„è³‡æ–™ã€‚

## è³‡æ–™åº«è³‡è¨Š

è³‡æ–™åº«ï¼ˆDatabaseï¼‰ä¸‹é¢æœƒæœ‰è³‡æ–™è¡¨ï¼ˆTableï¼‰ï¼›è€Œè³‡æ–™è¡¨çš„åŸºæœ¬æ¶æ§‹å’Œè¡¨æ ¼ä¸€æ¨£ï¼Œä»¥æ¬„èˆ‡åˆ—æ§‹æˆã€‚è€Œé€™äº›è³‡æ–™è¡¨ï¼Œéƒ½è¦æœ‰ä¸€å€‹ä¸»éµï¼ˆKey valueï¼‰ä»¥è³‡è¾¨è­˜ã€‚

## é—œè¯å¼è³‡æ–™åº«

åœ¨é—œè¯å¼è³‡æ–™åº«ï¼ˆRelational databaseï¼‰çš„é«”ç³»ä¸‹ï¼Œé–‹ç™¼è€…å¯ä»¥é€éè³‡æ–™è¡¨çš„éµå€¼èˆ‡å¤–ä¾†éµï¼ˆForeign keyï¼‰ï¼Œèˆ‡å…¶ä»–çš„è³‡æ–™è¡¨çµåˆã€‚åªä¸éï¼Œä¸€å€‹è³‡æ–™è¡¨çš„éµå€¼ï¼Œåªèƒ½å°æ‡‰å¦ä¸€å€‹è³‡æ–™è¡¨çš„å¤–ä¾†éµã€‚å¦‚æœéœ€è¦å°æ‡‰å¤šå€‹è³‡æ–™è¡¨çš„å¤–ä¾†éµï¼Œä¹Ÿå°±æ˜¯è¢«ç¨±ç‚º[å¤šå‹é—œè¯](https://stackoverflow.com/a/2003042/7162445)ï¼ˆPolymorphic Associationsï¼‰çš„æ±è¥¿......æˆ‘é‚„æ²’çœ‹åˆ°è§£æ±ºè¾¦æ³•ï¼Œä½†ä¼¼ä¹èˆ‡å¾Œç«¯ç¨‹å¼èªè¨€æœ‰é—œï¼Ÿ ğŸ¤”

## æŒ‡ä»¤å‚™æŸ¥

ä»¥ MySQL/MariaDB ç³»åˆ—æŒ‡ä»¤ç‚ºæº–ã€‚

* `SELECT`ï¼šé¸å–éœ€è¦çš„æ¬„ä½ã€‚æ¬„ä½ä¸­é–“ä»¥ `,` åˆ†é–‹ã€‚ä¾‹å¦‚ `SELECT name,gdp`ã€‚
* `FROM`ï¼š`FROM` å¾Œé¢è¦æ¥çš„æ˜¯è³‡æ–™è¡¨åç¨±ã€‚å‡è¨­ `sqlzoo` è³‡æ–™åº«ä¸‹é¢æœ‰ `world` è³‡æ–™è¡¨çš„è©±ï¼Œå¯ä»¥ç”¨ï¼š
  * `FROM world`: é€™æœƒåœ¨ `sqlzoo` è³‡æ–™åº«ä¸‹é¢å°‹æ‰¾ `world` è³‡æ–™è¡¨ã€‚
  * `FROM sqlzoo.world`: é€™æœƒåœ¨ `sqlzoo` è³‡æ–™åº«ä¸‹é¢é¸å– `world` è³‡æ–™è¡¨ã€‚
* `WHERE`ï¼šé™å®šæœå°‹æ¢ä»¶ã€‚è³‡æ–™è¡¨æŸ¥æ‰¾çš„éˆé­‚ã€‚
  * å¯ä»¥åœ¨ `WHERE` è£¡é¢ï¼Œç”¨å…¶ä»–è³‡æ–™ä¾†æŸ¥æ‰¾è³‡æ–™ï¼šå¦‚ `WHERE population > (SELECT population FROM world WHERE name='Canada')` å°±æ˜¯æ‰¾å‡ºæ‰€æœ‰äººå£å¤šæ–¼ `Canada` çš„åœ‹å®¶ã€‚
* `LEFT( æ¬„ä½åç¨±, çµ¦å®šå­—æ•¸ )`ï¼šé‡å°æ–‡å­—æ¬„ä½ï¼Œå‚³å›æŒ‡å®šæ•¸å­—çš„å­—å…ƒã€‚ä¾‹å¦‚ `LEFT( name, 5 )` å°±æœƒçµ¦å‡º `Afgha`, `Cuba`, `Japan`, `Zimba` é€™æ¨£çš„å­—å…ƒã€‚
* `=`, `<>`ï¼š`=` æ˜¯ç­‰æ–¼ã€ `<>` æ˜¯ä¸ç­‰æ–¼ã€‚å ±å‘Šå®Œç•¢ã€‚
* `LIKE`ï¼šæ¨¡ç³Šå­—è©æœå°‹ï¼Œè€Œä¸åªæœ‰å–®ç´”çš„å…¨æœ‰å…¨ç„¡ã€‚
  * `%`æœƒé…å°ä»»ä½•å­—å…ƒï¼ŒåŒ…æ‹¬ç©ºç™½ã€ç›´åˆ°ç›¡é ­ï¼› `_`å‰‡æœƒé…å°ä»»ä½•**ä¸€å€‹**å­—å…ƒã€‚
  * é…å°å­—å…ƒæ”¾åœ¨ç‰¹å®šå­—å…ƒå‰é¢ï¼Œå°±æœƒå»æŸ¥æ‰¾ç‰¹å®šå­—å…ƒå‰é¢çš„å­—å…ƒï¼Œåä¹‹äº¦ç„¶ã€‚
  * `Java%` æœƒé…å°åˆ° `Java`, `JavaScript`, `Java island`ã€‚
  * `%SQL%` æœƒé…å°åˆ° `MySQL`, `SQL Server`ã€‚
  * `__SQL` æœƒé…å°åˆ° `MySQL`ã€‚
* `ROUND( æ¬„ä½åç¨±, åˆå§‹é€²ä½æ•¸ )`ï¼šé‡å°æ•¸å­—æ¬„ä½ï¼Œå‚³å›æŒ‡å®šçš„å°æ•¸ã€‚å°æ•¸å–æ¨ç‚ºå››æ¨äº”å…¥ã€‚ä¾‹å¦‚ 1234.56 é€™æ•¸å­—ï¼š
  * `ROUND( 1234.56 )`, `ROUND( 1234.56, 0 )`ï¼š1235
  * `ROUND( 1234.56, 1 )`ï¼š1234.6
  * `ROUND( 1234.56, 2 )`ï¼š1234.56
  * `ROUND( 1234.56, 4 )`ï¼š1234.5600
  * `ROUND( 1234.56, -1 )`ï¼š1230
  * `ROUND( 1234.56, -2 )`ï¼š1200
* é‚è¼¯é…å°ã€Œæˆ–èˆ‡éã€ï¼ˆ`OR`, `AND`, `NOT`, `XOR`ï¼‰ã€‚æ¯”è¼ƒç‰¹åˆ¥çš„æ˜¯ `XOR`ï¼šå®ƒæœƒæŠŠ**å…¨éƒ½ç¬¦åˆ**èˆ‡**å…¨éƒ½ä¸ç¬¦åˆ**éæ¿¾æ‰ã€‚
* `LENGTH( è¼¸å…¥åç¨± )`ï¼šå¯ä»¥çµ¦å‡ºè©²è¼¸å…¥çš„å­—ä¸²é•·åº¦ã€‚ä¾‹å¦‚ `LENGTH( name )` å°±æœƒé¡¯ç¤ºå‡ºå„åœ‹çš„å­—ä¸²é•·åº¦Afghanistan ç‚º 11ã€Austria ç‚º 7 ä¹‹é¡çš„ã€‚
* æ•¸å­—æ¬„ä½å¯ä»¥è¢«è¨ˆç®—ï¼Œä¾‹å¦‚ `gdp/population`ã€‚
* `LIMIT æ•¸å­—`ï¼šè³‡æ–™åº«å¯èƒ½ä¸€å€‹æ¢ä»¶å…§æœ‰å¾ˆå¤šè³‡æ–™ã€‚å¦‚æœé æœŸåªæƒ³æŠ“åˆ°å¹¾å€‹è³‡æ–™ï¼Œå¯ä»¥ä¸‹ `LIMIT` é—œéµå­—ï¼šä¾‹å¦‚ `WHERE population > 100000000 LIMIT 3`ï¼Œå°±æœƒçµ¦å‡ºä¸‰å€‹äººå£è¶…é 100000000ï¼ˆä¸€å„„ï¼‰çš„åœ‹å®¶ã€‚
* `ORDER BY`ï¼šæŒ‰ç…§æŸç¨®é †åºæ’åºã€‚å¾Œé¢èƒ½ä¸‹é—œéµå­—ï¼šå¯ä»¥æ˜¯æ•¸å­—ã€ä¹Ÿå¯ä»¥æ˜¯ç¾…é¦¬å­—æ¯ã€‚
  * `DESC` ç‚ºå‡åºã€`ASC` ç‚ºé™åºã€‚
* [`JOIN`](https://mariadb.com/kb/en/joining-tables-with-join-clauses)ï¼šèˆ‡å…¶ä»–è³‡æ–™è¡¨ä½œçµåˆï¼Œç”¢å‡ºçš„è³‡æ–™è¡¨å°±æœƒåŒæ™‚æœ‰å…©å€‹è³‡æ–™è¡¨çš„è³‡æ–™äº†ã€‚é€™å€‹æŒ‡ä»¤éœ€è¦é…åˆå¹¾å€‹æŒ‡ä»¤ï¼š
  * é¦–å…ˆä½ è¦æ±ºå®šç”¨ä»€éº¼æ¢ä»¶ï¼Œèˆ‡å…¶ä»–è³‡æ–™è¡¨åšçµåˆã€‚æ±ºå®šå¥½å¾Œï¼Œå†ç”¨ `ON` ä¾†æ±ºå®šé€™å€‹æ¢ä»¶ã€‚
  * çµåˆæ–¹æ³•
    * `INNER`ï¼šå¿…é ˆè¦åœ¨å‰è¿°çš„å…©è€…å»åˆæ™‚ï¼Œæ‰æ”¶å…¥é€™ç­†è³‡æ–™ã€‚ä¸å»åˆçš„ï¼Œå°±æœƒè‡ªå‹•ä¸åˆ—å…¥ã€‚
    * `CROSS`ï¼šä»¥å‡ºç¾é †åºï¼Œç„¡æ¢ä»¶çµåˆè³‡æ–™ã€‚
    * `LEFT`ï¼šä»¥å‡ºç¾é †åºï¼Œç„¡æ¢ä»¶çµåˆè³‡æ–™ã€‚ä¸å»åˆçš„ï¼Œä»¥å·¦é‚Šï¼ˆè¢«çµåˆçš„ï¼‰è³‡æ–™è¡¨ç‚ºæº–ã€‚
    * `RIGHT`ï¼šä»¥å‡ºç¾é †åºï¼Œç„¡æ¢ä»¶çµåˆè³‡æ–™ã€‚ä¸å»åˆçš„ï¼Œä»¥å³é‚Šï¼ˆè¦çµåˆçš„ï¼‰è³‡æ–™è¡¨ç‚ºæº–ã€‚
  * `ON`ï¼šèˆ‡å…¶ä»–è³‡æ–™è¡¨ä½œçµåˆçš„ä¾æ“šã€‚å¦‚æœä¸ä¸‹é€™å€‹æŒ‡ä»¤ï¼Œå‰‡è³‡æ–™è¡¨æœƒä»¥å‡ºç¾é †åºï¼Œç„¡æ¢ä»¶çµåˆè³‡æ–™ï¼ˆä¹Ÿå°±æ˜¯ `CROSS JOIN`ï¼‰ï¼›ä½†å¦‚æœä¸‹äº†ï¼Œå°±æœƒæŒ‰ç…§å…©å€‹è³‡æ–™è¡¨æ‰€æŒ‡å®šçš„æ•¸å€¼ç‚ºçµåˆä¾æ“šï¼šä¾‹å¦‚èªª `JOIN something ON something.sid = another.thing` çš„è©±ï¼Œè³‡æ–™å°‡æ¯”å° `something` çš„ `sid` å’Œ `another` çš„ `thing`ï¼Œä¸¦å°‡å»åˆå…©è€…çš„æ¬„ä½ï¼Œç•¶ä½œæ˜¯åŒä¸€ç­†è³‡æ–™ã€‚
* `INSERT INTO` æ˜¯éœ€è¦æ’å…¥æ•¸å€¼çš„**æŒ‡ä»¤**ï¼›è€Œ `VALUES` å‰‡æ˜¯éœ€è¦æ’å…¥æ•¸å€¼çš„**è³‡æ–™**ã€‚
  * ä¹Ÿå°±æ˜¯èªªä½ æœƒé€™æ¨£ç”¨ï¼š`INSERT INTO some VALUES (1,'PIECE');`ã€‚

## Nested query & subquery (å·¢ç‹€æŸ¥è©¢èˆ‡å­æŸ¥è©¢)

[æ²æ¯›è”¡](https://ithelp.ithome.com.tw/articles/10219497)ï¼šã€Œåœ¨ SELECT æŒ‡ä»¤å…§å†æ”¾ä¸€å€‹ SELECT æŒ‡ä»¤æŸ¥è©¢ï¼›é€šå¸¸æ”¾åœ¨ SELECT å¾Œé¢çš„ WHERE å­å¥ï¼Œå¯å–å¾—è©³ç´°æŸ¥è©¢æ¢ä»¶ã€‚ã€

---

```sql
-- https://learnsql.com/blog/sql-nested-select/
SELECT * FROM Students WHERE Students.GPA > ( SELECT AVG(Students.GPA) FROM Students );
SELECT AVG(Classes.number_of_students) FROM Classes WHERE Classes.teacher_id IN (
    SELECT Teachers.id FROM Teachers WHERE Teachers.subject = 'English' OR Teachers.subject = 'History'
);
```

---

People
id 	Name 	Age
1 	Titan 	18
2 	John 	6
3 	Alex 	40
4 	Back 	36
5 	Deed 	22

Marriage
id 	spouse_id
1 	5
5 	1
3 	4
4 	3

```sql
-- To find someone who is single
SELECT * FROM People WHERE People.id NOT IN ( SELECT Marriage.spouse_id FROM Marriage );

-- Show:
-- id 	Name 	Age
-- 2 	John 	6
```

* <https://learnsql.com/blog/sql-nested-select>

## correlated or synchronized sub-query ï¼ˆç›¸é—œå­æŸ¥è©¢æˆ–åŒæ­¥å­æŸ¥è©¢ï¼‰

ã€Œæˆ‘å€‘å¯ä»¥åœ¨å­æŸ¥è©¢ï¼Œåƒé–±å¤–éƒ¨æŸ¥è©¢çš„æ•¸å€¼ã€‚æˆ‘å€‘ç‚ºè¡¨æ ¼å†å‘½åï¼Œä¾¿å¯ä»¥åˆ†åˆ¥å…§å¤–å…©å€‹ä¸åŒçš„è¡¨æ ¼ã€‚ã€

## é€£çµ

* [SQLZoo](https://sqlzoo.net)
* [Basic SQL Statements](https://mariadb.com/kb/en/library/basic-sql-statements)